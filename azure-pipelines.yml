trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
- script: echo "K8S Terraform Azure!"
  displayName: 'Run a one-line script'

- task: DownloadSecureFile@1
  name: publickey
  inputs:
    secureFile: 'azure_rsa.pub'

# ðŸ§© Install Terraform (Fully Qualified Task)
- task: JasonBJohnson.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@1
  displayName: 'Install Terraform'

# ðŸ§© Azure CLI login
- task: AzureCLI@2
  displayName: 'Azure CLI: login with service connection'
  inputs:
    azureSubscription: 'azure-resource-service-manager'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -euo pipefail
      echo 'Azure login info:'
      az account show
      echo 'Defensive checks before running terraform'
      # Set ARM service principal env vars so Terraform authenticates with SP (not Azure CLI user)
      # client_id and client_secret are pipeline variables (secrets). Do not echo them.
      export ARM_CLIENT_ID="$(client_id)"
      export ARM_CLIENT_SECRET="$(client_secret)"
      # Derive subscription and tenant from the logged-in az account
      export ARM_SUBSCRIPTION_ID="$(az account show --query id -o tsv)"
      export ARM_TENANT_ID="$(az account show --query tenantId -o tsv)"

      # Verify terraform is available
      if ! command -v terraform >/dev/null 2>&1; then
        echo "ERROR: terraform is not installed or not on PATH. Ensure the Terraform installer task ran earlier and added terraform to PATH."
        exit 1
      fi
      terraform --version

      # Working directory
      WORKDIR="$(System.DefaultWorkingDirectory)/configuration/iaac/azure/kubernetes"
      if [ ! -d "$WORKDIR" ]; then
        echo "ERROR: working directory does not exist: $WORKDIR"
        exit 1
      fi

      echo 'Running terraform init'
      cd "$WORKDIR"
      terraform init \
    -backend-config="resource_group_name=terraform-backend-rg" \
    -backend-config="storage_account_name=storageacctmanju17099" \
    -backend-config="container_name=terraform-state" \
        -backend-config="key=kubernetes-dev.tfstate"

      echo 'Running terraform apply'
      terraform apply -auto-approve \
        -var "client_id=$(client_id)" \
        -var "client_secret=$(client_secret)" \
        -var "ssh_public_key=$(publickey.secureFilePath)"














# trigger:
#   branches:
#     include:
#       - main

# pool:
#   vmImage: 'ubuntu-latest'

# stages:
# - stage: build
#   jobs:
#   - job: FirstJob
#     steps:
#     - bash: |
#         echo "Build FirstJob"

#     - bash: |
#         echo $(PipelineLevelVariable)

#     - bash: |
#         echo $(Build.BuildNumber)

#     - bash: |
#         echo $(Build.BuildId)

#     - bash: |
#         echo $(Build.SourceBranchName)

#     - bash: |
#         echo $(Build.SourcesDirectory)

#     - bash: |
#         echo $(System.DefaultWorkingDirectory)

#     - bash: |
#         ls -R $(System.DefaultWorkingDirectory)

#     - bash: |
#         echo $(Build.ArtifactStagingDirectory)

#     - bash: |
#         java -version
#         node --version
#         python3 --version
#         mvn -version

#     - bash: |
#         ls -R '$(Build.ArtifactStagingDirectory)'

#     - task: CopyFiles@2
#       inputs:
#         SourceFolder: '$(System.DefaultWorkingDirectory)'
#         Contents: |
#           **/*.yaml
#           **/*.tf
#         TargetFolder: '$(Build.ArtifactStagingDirectory)'

#     - task: PublishBuildArtifacts@1
#       inputs:
#         PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#         ArtifactName: 'drop'
#         publishLocation: 'Container'

  


# resources:
# - repo: self

# variables:
#   tag: $(Build.BuildId)

# stages:
# - stage: Build
#   displayName: Build image
#   jobs:
#   - job: Build
#     displayName: Build and Push Docker Image
#     pool:
#       vmImage: 'ubuntu-latest'
#     steps:
#     - task: Docker@2
#       displayName: Build & Push Image
#       inputs:
#         containerRegistry: 'Manju dockerhub'
#         repository: 'manjunathk165.kmr@gmail.com/currency-exchange-devops'
#         command: 'buildAndPush'
#         dockerfile: '**/Dockerfile'
#         tags: |
#           $(tag)
#           latest


















# pool:
#   vmImage: 'ubuntu-latest'
# strategy:
#   matrix:
#     linux:
#       operatingSystem: 'ubuntu-latest'
#     mac:
#       operatingSystem: 'macos-latest'
# pool:
#   vmImage: 'ubuntu-latest'

# stages:
# - stage: Build
#   jobs:
#   - job: BuildJob
#     steps:
#     - bash: |
#         echo "Do the BuildJob"

# - stage: DevDeploy
#   jobs: 
#   - deployment: DevDeployJob
#     environment: Dev
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - script: echo "Deploy to Dev"

# - stage: QADeploy
#   jobs: 
#   - deployment: QADeployJob
#     environment: QA
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - script: echo "Deploy to QA"


      


       




# steps:
# - script: echo Running on $(operatingSystem)
#   displayName: 'Run a one-line script'


        

# stages:
# - stage: build
#   jobs:
#   - job: FirstJob
#     steps:
#     - bash: |
#         echo "Build FirstJob"

#     - bash: |
#         echo $(PipelineLevelVariable)

#     - bash: |
#         echo $(Build.BuildNumber)

#     - bash: |
#         echo $(Build.BuildId)

#     - bash: |
#         echo $(Build.SourceBranchName)

#     - bash: |
#         echo $(Build.SourcesDirectory)

#     - bash: |
#         echo $(System.DefaultWorkingDirectory)

#     - bash: |
#         ls -R $(System.DefaultWorkingDirectory)

#     - bash: |
#         echo $(Build.ArtifactStagingDirectory)

#     - bash: |
#         java -version
#         node --version
#         python3 --version
#         mvn -version

#     - bash: |
#         ls -R '$(Build.ArtifactStagingDirectory)'

#     - task: CopyFiles@2
#       inputs:
#         SourceFolder: '$(System.DefaultWorkingDirectory)'
#         Contents: |
#           **/*.yaml
#           **/*.tf
#         TargetFolder: '$(Build.ArtifactStagingDirectory)'
#     - task: PublishBuildArtifacts@1
#       inputs:
#         PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#         ArtifactName: 'drop'
#         publishLocation: 'Container'

       

  # - job: SecondJob
  #   steps:
  #   - bash: |
  #       echo Build SecondJob
# - stage: Devdeploy
#   variables:
#     environment: Dev
#   jobs:
#   - job: DevdeployJob
#     steps:
#     - bash: |
#         echo Build $(environment)deployJob
# - stage: QAdeploy
#   variables:
#     environment: QA
#   jobs:
#   - job: QAdeployJob
#     steps:
#     - bash: |
#         echo Build $(environment)deployJob
# - stage: Proddeploy
#   variables:
#     environment : Prod
#   jobs:
#   - job: ProddeployJob
#     steps:
#     - bash: |
#         echo Build $(environment)deployJob
#         echo "This is Proddeploy stage"

# Pipelines > Stages > Jobs > Tasks(Steps)

#jobs:
#- job: job1
#  steps:
  #- script: echo job1 -  Hello, world,Changed!
   # displayName: 'Run a one-line script'
   
  #- script: |
      # echo Add other tasks to build, test, and deploy your project.
      # echo See https://aka.ms/yaml
      # echo This is a multi-line script.
    #displayName: 'Run a multi-line script'
# -  job: job2
   # dependsOn: job1
   # steps:
   # - script: echo job2!
     #displayName: 'Run a one-line script'
# -  job: job3
   # dependsOn: job1
   #steps:
   # - script: echo job3!
     # displayName: 'Run a one-line script'
# -  job: Job4
   #dependsOn:
   # - job2
   # - job3
   #steps:
   #- script: echo job3!
     # displayName: 'Run a one-line script'

